\documentclass[a4paper,12pt]{article} % Prepara un documento per carta A4, con un bel font grande

% impostazioni generali del documento, valide per tutti gli scritti.

\usepackage{graphicx} % per l'inserimento di immagini.
\usepackage{listings}
\lstloadlanguages{PROLOG}
\usepackage[italian]{babel} % Adatta LaTeX alle convenzioni tipografiche italiane,
% e ridefinisce alcuni titoli in italiano, come "Capitolo" al posto di "Chapter", se il vostro documento in italiano
\usepackage[utf8]{inputenc} % Consente l'uso caratteri accentati italiani


\usepackage{fancyhdr} % per il controllo delle intestazioni.
\usepackage{totpages} % macro per conoscere il tatale delle pagine
\usepackage{longtable} % tabelle che vanno su pi� pagine
\frenchspacing % forza LaTeX ad una spaziatura fra parole non inglesi

\pagestyle{fancy}

\newcommand{\linkref}[1]{{\footnotesize \textsl{#1}}}


% fine delle impostazioni generali

\newtoks\titolo % definisco un nuovo comando \titolo che restituisce il titolo.
\newtoks\versione % definisco un nuovo comando \versione che restituisce il versione.
\newtoks\data   % definisco un nuovo comando \data che restituisce la data.

\titolo={Port scans detector with prolog} % inserire qui il titolo

\data={\today}       % today restituisce il valore del giorno in cui si genera il pdf.

\title{\bf \the\titolo}
\author{}
\date{\the\data}

\input{intestazione.tex} % inserisco le intestazioni del doc: logo, nome etc..

\begin{document}

\input{prima_pagina.tex}

\newpage

\tableofcontents

\newpage

\section{Introduzione}

In questo progetto è stato realizzato un \emph{port scanners detector} che utilizza \textbf{Prolog} per il riconoscimento
di un port scanning.\\

Il port scanning è una tecnica che viene utilizzata per l'identificazione delle porte "aperte" in un host remoto.
Come si sa, infatti, quando si apre un servizio questo si mette in ascolto delle connessioni in entrata su una determinata porta, assegnata dal sistema 
operativo.

Alcuni di questi servizi molto spesso possono essere vulnerabili e quindi sfruttabili dall'esterno per ottenere accesso
non autorizzato. Il \emph{port scanning} viene utilizzato dunque per il riconoscimento di quali servizi sono attivi ed
è il primo passo prima di un eventuale attacco.\\


Esistono vari software sul mercato che eseguono l'analisi degli host di una rete per il riconoscimento di intrusioni 
non autorizzate e vengono chiamati \emph{Intrusion detection systems}. Questi software possono essere molto evoluti 
e sfruttare tecniche di \emph{intelligenza artificiale} o \emph{apprendimento automatico} per le loro attività che possono essere analisi del traffico di rete, dei log oppure del carico cpu o I/O del sistema. All'interno di questi software è 
presente un modulo per il riconoscimento di scansioni di porte. \\

In questo progetto si è voluto realizzare uno di questi possibili moduli utilizzando una base di conoscenza
realizzata in \emph{Prolog}.  



\section{Consuntivo}

Per la realizzazione del progetto sono state impiegate all'incirca 100 ore complessive distribuite in questo modo:

\begin{itemize}

\item 50 ore per lo studio della progettazione e lo studio delle tecnologie da utilizzare nel progetto
\item 40 ore per lo sviluppo 
\item 10 ore per la stesura di questa relazione


\end{itemize}


\newpage

\section{Use case}

Sono stati progettati 2 casi d'uso principali:
\begin{figure}[htbp]
 \begin{center}
  \includegraphics[width=15cm]{usecase1.png}
  \end{center}
  \caption{\label{fig_caso_generale} Casi d'uso}
 \end{figure}\\


\begin{itemize}


\item analisi \textbf{offline} da file: l'utente puo' far analizzare un file di traffico precedentemente catturato. In gergo
il traffico viene "sniffato", vengono catturati i pacchetti e salvati su file. I programmi maggiormente utilizzati per la cattura sono \textbf{tcpdump} e \textbf{Wireshark}. Il primo esegue da riga di comando e il secondo è una sua interfaccia grafica. Dopo aver catturato il traffico, l'utente esegue l'analisi del file e il sistema riporta 
la presenza o meno di un port scanning da parte di un host remoto e il suo indirizzi ip.

\item analisi \textbf{online} del traffico di rete: l'utente esegue il software che effettua lo "sniffing" live 
del traffico e in modo continuativo la sua analisi. Se viene rilevato uno scanning il sistema esce e riporta la presenza dello scannning e dell'host remoto che l'ha eseguito e il suo indirizzo ip. 

\end{itemize}


\section{Strumenti}

Nel progetto sono stati utilizzati principalmente 2 tool di supporto:

\begin{itemize}

\item \textbf{nmap}: il port scanner open source più utilizzato. Ha moltissime opzioni ed implementa praticamente 
ogni tecnica di port scanning conosciuta.

\item \textbf{wireshark}: uno \emph{sniffer} per l'analisi del traffico. Questo tool l'abbiamo utilizzato per effettuare
il \emph{reverse engineering} di come nmap effettua il port scanning e per salvare il traffico per l'analisi del detector.



\end{itemize}




\section{Scenari}

In questa sezione verranno illustrati i vari possibili scenari in cui l'applicazione vedrà il suo utilizzo. 
In una prima fase l'applicazione verrà installata su uno degli host della propria rete, verrà messa dunque in modalità di sniffing o oppure
gli verrà caricato un file di traffico salvato precendentemente. 
Dopo di ciò i casi in cui ci si potrà trovare sono fondamentalmente 2:

\begin{itemize}

\item l'host sul quale è installata l'applicazione non ha servizi attivi, dunque tutte le sue porte sono chiuse.

\item l'host ha attivi alcuni servizi.

\end{itemize}


L'applicazione dunque monitorerà l'host ed "informerà" l'eventuale amministratore di una scansione di porte.\\
Ora dobbiamo vedere quali sono i possibili casi per questa scansione:


\begin{itemize}

\item un host remoto effettua una scansione generale su tutte le porte dell'host.

\item un host remoto scansiona solo un piccolo range di porte, queste possono essere proprio le stesse porte attive sull'host, diciamo 
\emph{n porte} oppure le porte dell'host ed alcune altre, dunque \emph{n + k}.

\end{itemize}


In tutti e due i casi il nostro detector deve avvisare della scansione in corso.




\section{Protocollo Tcp e port scanning}

\begin{figure}[htbp]
\centering
\includegraphics[width=10cm]{tcp.png}
\caption{\label{Protocollo tcp} Protocollo Tcp}
\end{figure}



Nella figura è rappresentata una \emph{connessione tcp} \emph{client-server}. Come si sa, una connessione tcp è formata dal cosidetto
\emph{Three-way handshake} che puo' essere riassunto così:

\begin{itemize}

\item il client invia al server un pacchetto con \textbf{flag SYN} impostato ad 1 (attivo) e il campo \emph{sequence number}
inizializzato ad un numero casuale \emph{x}.


\item il server risponde con un pacchetto con \textbf{flag SYN} e \textbf{flag ACK} impostati ad 1, il campo \textbf{sequence number}
impostato ad un valore casuale y e il campo \emph{Acknowledgment number} uguale a \emph{x + 1} e 

\item il client risponde al messaggio del server con un pacchetto con \textbf{flag ACK} attivo, il campo \emph{Acknowledgment number} impostato a y + 1 e il campo \textbf{sequence number} uguale a \emph{x + 1}. Ora il client puo' iniziare
l'invio dei dati al server.


\item se la porta del server sulla quale vuole comunicare il client è chiusa, dopo il primo passaggio il server risponde con un pacchetto con \textbf{flag RST} (reset) attivo e con campo \emph{sequence number} e {Acknowledgment number} come nel secondo passaggio prima. Con il flag rst la connessione tcp viene interrotta e in questo modo il client riconosce che la porta sul server è chiusa e che quindi non puo' comunicare.


\end{itemize}

\newpage

Uno port scanning non è altro che il tentativo di aprire porte su di un server e riportare quali di queste sono aperte e quali sono
chiuse. Il nostro ports scan detector riesce a riconoscere 2 tipi di port scanning:

\begin{itemize}

\item \textbf{TCP connect scan}: il client completa tutto il \emph{Three-way handshake} su 
ognuna delle porte sottoposte a scanning. E' la tecnica più "rumorosa" perchè genera molto traffico ma è anche quella più
affidabile.

\item \textbf{SYN scan}: il client non completa tutte le fasi del protocollo TCP ma si ferma dopo che il server ha risposto con 
il primo pacchetto con \textbf{flag SYN} attivo. Se la porta non fosse aperta infatti il server avrebbe risposto con un pacchetto con 
flag \textbf{RST} attivo. Dunque è corretto ritenere la porta sia aperta.

\end{itemize}




\section{Progettazione}


\begin{figure}[htbp]
\centering
\includegraphics[width=10cm,height=10cm]{attivita.png}
\caption{\label{Diagramma delle attivita} Diagramma delle attivita}
\end{figure}



La figura rappresenta il \emph{diagramma delle attività} dell'intero software. Come si puo' vedere
all'inizio vengono richiesti e parametri di inizializzazione da parte dell'utente: questi sono del tipo: 



\textbf{kb.pl n\_connections file.pcap sniffer seconds\_retract\_timer}: il primo parametro è la base di conoscenza
scritta in prolog (nelle successive sezioni la descriveremo approfonditamente), il secondo parametro è il numero di connessioni
tcp che devono essere attive affinchè venga riconosciuto un port scanning, il terzo parametro invece puo'rappresentare un 
file di traffico "sniffato" oppure essere la stringa "sniffer": nel primo caso il software effettua l'analisi del file ed inferisce
lo scan o meno, nel secondo caso si avvia in modalità "demone" ed effettua l'analisi \emph{online}. Infine il terzo parametro
rappresenta il numero di secondi da aspettare affinchè venga avviato il Thread che effettua il retract dei "fatti" della base di 
conoscenza.





Questo è il diagramma delle classi del progetto:



\begin{figure}[htbp]
\centering
\includegraphics[width=15cm]{classi.png}
\caption{\label{Diagramma delle classi} Diagramma delle classi}
\end{figure}


Descrizione dettagliata delle classi e dei loro metodi:\\


\textbf{SNIFFER}

\begin{itemize}

\item start():
\item readFile():
\item receivePacket():

\end{itemize}



\textbf{ANALYZER}



\begin{itemize}

\item retractPackets():

\item createPacket():

\item assertPacket():

\item createStringScan():

\item createRuleTcpScan():

\item initializeKB():

\item query():
\end{itemize}

\textbf{RETRACTIMER}



\section{Tecnologie}

Il progetto è stato realizzato in \emph{Java}. Le librerie che sono state utilizzate sono:


\begin{itemize}

\item jpcap: porting in java della libreria pcap per l'analisi del traffico di rete.

\item tuprolog: libreria java per utilizzare prolog all'interno di codice java. Tra le molte disponibili
è stata utilizzata questa per le migliori prestazioni rispetto alle altre.

\end{itemize}


\section{Inferenza}
\lstinputlisting{kb.pl}


\section{Compilazione ed esecuzione del progetto}



\section{Risultati}



\section{Sviluppi futuri}
\end{document}
